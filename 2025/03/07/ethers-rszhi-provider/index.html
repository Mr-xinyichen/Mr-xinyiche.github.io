<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ethers-rs之Provider, 立身于大雪弥漫、浓雾障眼的山口，只能偶尔瞥见未必正确的路径，只需睁大双眼，昂起头颅，走好脚下的路，不管它通向何方。">
    <meta name="description" content="Http 提供者（Provider）Http 提供者通过 HTTP 连接到以太坊节点，允许你发送 RPC 请求以获取数据、模拟合约调用、发送交易等。

1.初始化 Http 提供者1. 使用 try_from 方法创建 Provider最简">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="white"/>
    <title>ethers-rs之Provider | Sparks Fly</title>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <style type="text/css">
        
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }

        
    </style>
    <script src="/libs/jquery/jquery.min.js"></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Sparks Fly" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                        <img src="/apple-touch-icon.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Sparks Fly</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
        <li class="hide-on-med-and-down nav-item">

            
                <a href="/" class="waves-effect waves-light">
                    
                        <i class="fa fa-home"></i>
                    
                    <span>首页</span>
                </a>

            
        </li>
    
        <li class="hide-on-med-and-down nav-item">

            
                <a href="/categories" class="waves-effect waves-light">
                    
                        <i class="fa fa-bookmark"></i>
                    
                    <span>分类</span>
                </a>

            
        </li>
    
        <li class="hide-on-med-and-down nav-item">

            
                <a href="/archives" class="waves-effect waves-light">
                    
                        <i class="fa fa-archive"></i>
                    
                    <span>归档</span>
                </a>

            
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
            <img src="/medias/avatars/avatar.png"
                 class="logo-img circle responsive-img">
        
        <div class="logo-name">Sparks Fly</div>
        <div class="logo-desc">
            
                Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
            <li class="m-nav-item">
                
                    <a href="/" class="waves-effect waves-light">
                        
                            <i class="fa fa-fw fa-home"></i>
                        
                        首页
                    </a>
                
            </li>
        
            <li class="m-nav-item">
                
                    <a href="/categories" class="waves-effect waves-light">
                        
                            <i class="fa fa-fw fa-bookmark"></i>
                        
                        分类
                    </a>
                
            </li>
        
            <li class="m-nav-item">
                
                    <a href="/archives" class="waves-effect waves-light">
                        
                            <i class="fa fa-fw fa-archive"></i>
                        
                        归档
                    </a>
                
            </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ethers-rs之Provider</h1>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
        <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">Awsome</span>
                        </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                        <div class="post-cate">
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                                <a href="/categories/WEB3/" class="post-category">
                                    WEB3
                                </a>
                            
                        </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                        2025-03-07
                    </div>
                

                
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-check-o fa-fw"></i>更新日期:&nbsp;&nbsp;
                        2025-03-07
                    </div>
                

                
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.6k
                    </div>
                

                
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        32 分
                    </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="Http-提供者（Provider）"><a href="#Http-提供者（Provider）" class="headerlink" title="Http 提供者（Provider）"></a><strong>Http 提供者（Provider）</strong></h2><p>Http 提供者通过 HTTP 连接到以太坊节点，允许你发送 RPC 请求以获取数据、模拟合约调用、发送交易等。</p>
<hr>
<h3 id="1-初始化-Http-提供者"><a href="#1-初始化-Http-提供者" class="headerlink" title="1.初始化 Http 提供者"></a><strong>1.初始化 Http 提供者</strong></h3><h4 id="1-使用-try-from-方法创建-Provider"><a href="#1-使用-try-from-方法创建-Provider" class="headerlink" title="1. 使用 try_from 方法创建 Provider"></a><strong>1. 使用 <code>try_from</code> 方法创建 Provider</strong></h4><p>最简单的方式之一是使用 <code>TryFrom</code> trait 的 <code>try_from</code> 方法：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Http<span class="token punctuation">,</span> Middleware<span class="token punctuation">,</span> Provider<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 初始化新的 HTTP 提供者</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h4 id="2-使用认证信息初始化-HTTP-连接"><a href="#2-使用认证信息初始化-HTTP-连接" class="headerlink" title="2. 使用认证信息初始化 HTTP 连接"></a><strong>2. 使用认证信息初始化 HTTP 连接</strong></h4><p><code>Http</code> 提供者还支持使用认证信息进行连接：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Authorization<span class="token punctuation">,</span> Http<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> url<span class="token punctuation">:</span><span class="token punctuation">:</span>Url<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 通过认证信息初始化 HTTP 连接</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8545"</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new_with_auth</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> Authorization<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">basic</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token string">"good_password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h4 id="3-使用自定义-reqwest-Client-初始化-Provider"><a href="#3-使用自定义-reqwest-Client-初始化-Provider" class="headerlink" title="3. 使用自定义 reqwest::Client 初始化 Provider"></a><strong>3. 使用自定义 <code>reqwest::Client</code> 初始化 Provider</strong></h4><p>你也可以使用自定义的 <code>reqwest::Client</code> 进行初始化：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span>Http<span class="token punctuation">;</span>
<span class="token keyword">use</span> url<span class="token punctuation">:</span><span class="token punctuation">:</span>Url<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8545"</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> client <span class="token operator">=</span> reqwest<span class="token punctuation">:</span><span class="token punctuation">:</span>Client<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new_with_client</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="2-基础用法"><a href="#2-基础用法" class="headerlink" title="2.基础用法"></a><strong>2.基础用法</strong></h3><p>成功建立 HTTP 连接后，你可以使用 <code>Middleware</code> trait 提供的方法。例如，下面的代码使用 <code>provider</code> 获取链 ID、当前区块号以及节点的交易池内容：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Http<span class="token punctuation">,</span> Middleware<span class="token punctuation">,</span> Provider<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">;</span>

    <span class="token keyword">let</span> chain_id <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get_chainid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> block_number <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> tx_pool_content <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">txpool_content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="3-使用-Provider-交互智能合约"><a href="#3-使用-Provider-交互智能合约" class="headerlink" title="3.使用 Provider 交互智能合约"></a><strong>3.使用 Provider 交互智能合约</strong></h3><p>你还可以使用 <code>provider</code> 与智能合约交互。以下示例展示了如何使用 <code>provider</code> 连接 Uniswap V2 池（<code>UniswapV2Pool</code>）并调用 <code>getReserves()</code> 方法获取池子当前的流动性储备信息：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    prelude<span class="token punctuation">:</span><span class="token punctuation">:</span>abigen<span class="token punctuation">,</span>
    providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Http<span class="token punctuation">,</span> Provider<span class="token punctuation">}</span><span class="token punctuation">,</span>
    types<span class="token punctuation">:</span><span class="token punctuation">:</span>Address<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Arc<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 生成智能合约接口</span>
<span class="token function">abigen!</span><span class="token punctuation">(</span>
    IUniswapV2Pair<span class="token punctuation">,</span>
    <span class="token string">"[function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)]"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 初始化 WETH/DAI Uniswap V2 交易对合约</span>
    <span class="token keyword">let</span> pair_address<span class="token punctuation">:</span> Address <span class="token operator">=</span> <span class="token string">"0xA478c2975Ab1Ea89e8196811F51A7B7Ade33eB11"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> uniswap_v2_pair <span class="token operator">=</span> IUniswapV2Pair<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>pair_address<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 调用 get_reserves() 方法获取池子流动性储备</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>reserve_0<span class="token punctuation">,</span> reserve_1<span class="token punctuation">,</span> block_timestamp_last<span class="token punctuation">)</span> <span class="token operator">=</span>
        uniswap_v2_pair<span class="token punctuation">.</span><span class="token function">get_reserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="4-代码解析"><a href="#4-代码解析" class="headerlink" title="4.代码解析"></a><strong>4.代码解析</strong></h3><p>这个示例稍微复杂一些，下面是它的关键点：</p>
<ol>
<li><code>IUniswapV2Pair</code> 是一个智能合约接口，由 <code>abigen!()</code> 宏生成。</li>
<li><code>IUniswapV2Pair::new()</code> 方法用于创建合约实例，参数包括：<ul>
<li><code>Address</code>（合约地址）</li>
<li><code>Arc&lt;M&gt;</code>（一个实现了 <code>Middleware</code> trait 的 <code>Provider</code>）。</li>
</ul>
</li>
<li>由于 <code>provider</code> 可能会在多个线程中共享，因此通常会用 <code>Arc</code> 包装它。</li>
</ol>
<hr>
<h3 id="5-跨线程使用-Provider"><a href="#5-跨线程使用-Provider" class="headerlink" title="5.跨线程使用 Provider"></a><strong>5.跨线程使用 Provider</strong></h3><p>通常，我们会使用 <code>Arc</code> 来包装 <code>provider</code> 以便在多个线程中共享。下面是一个示例，展示如何在两个 <code>tokio</code> 线程中并发查询区块链数据。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Http<span class="token punctuation">,</span> Middleware<span class="token punctuation">,</span> Provider<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Arc<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> current_block_number <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> prev_block_number <span class="token operator">=</span> current_block_number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 克隆 Arc&lt;Provider>，在新线程中查询当前区块的 Ommer 数量</span>
    <span class="token keyword">let</span> provider_1 <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> task_0 <span class="token operator">=</span>
        tokio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span>async <span class="token keyword">move</span> <span class="token punctuation">{</span> provider_1<span class="token punctuation">.</span><span class="token function">get_uncle_count</span><span class="token punctuation">(</span>current_block_number<span class="token punctuation">)</span><span class="token punctuation">.</span>await <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 在另一个线程中查询前一个区块的 Ommer 数量</span>
    <span class="token keyword">let</span> task_1 <span class="token operator">=</span> tokio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span>async <span class="token keyword">move</span> <span class="token punctuation">{</span> provider<span class="token punctuation">.</span><span class="token function">get_uncle_count</span><span class="token punctuation">(</span>prev_block_number<span class="token punctuation">)</span><span class="token punctuation">.</span>await <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 等待任务完成</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> <span class="token punctuation">[</span>task_0<span class="token punctuation">,</span> task_1<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Ok</span><span class="token punctuation">(</span>uncle_count<span class="token punctuation">)</span> <span class="token operator">=</span> task<span class="token punctuation">.</span>await? <span class="token punctuation">{</span>
            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"查询成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a><strong>6.总结</strong></h3><ul>
<li><code>Http</code> 提供者允许你通过 HTTP 访问以太坊节点，并发送 JSON-RPC 请求。</li>
<li>你可以使用 <code>Provider::try_from()</code> 初始化一个 HTTP 连接。</li>
<li><code>Middleware</code> trait 提供了丰富的区块链交互方法，例如获取区块号、交易池内容等。</li>
<li><code>abigen!()</code> 宏可以帮助生成智能合约接口，使 <code>provider</code> 可以与合约进行交互。</li>
<li>通过 <code>Arc</code> 共享 <code>provider</code>，可以在多个异步线程中使用它。</li>
</ul>
<h2 id="WebSocket-提供者（Ws-Provider）"><a href="#WebSocket-提供者（Ws-Provider）" class="headerlink" title="WebSocket 提供者（Ws Provider）"></a><strong>WebSocket 提供者（Ws Provider）</strong></h2><p><code>Ws</code> 提供者允许通过 <code>WebSocket</code> 连接发送 JSON-RPC 请求并接收响应，使程序能够<strong>实时</strong>与区块链网络交互，而无需使用 HTTP 轮询来获取新区块头和过滤日志等信息。</p>
<p><code>ethers-rs</code> 通过 <code>Tokio</code> 支持 <code>WebSocket</code>。在你的 <code>Cargo.toml</code> 配置文件中，需要启用 <code>"ws"</code> 以及 <code>"rustls"</code> 或 <code>"openssl"</code> 功能才能使用 WebSocket。</p>
<p><code>WebSocket</code> 连接方式适用于 <strong>实时交易监听、事件订阅</strong> 等高频交互场景，是比 <code>HTTP</code>更优的选择</p>
<hr>
<h3 id="1-初始化-WebSocket-提供者"><a href="#1-初始化-WebSocket-提供者" class="headerlink" title="1.初始化 WebSocket 提供者"></a><strong>1.初始化 WebSocket 提供者</strong></h3><h4 id="1-最简单的-Ws-提供者初始化方式"><a href="#1-最简单的-Ws-提供者初始化方式" class="headerlink" title="1. 最简单的 Ws 提供者初始化方式"></a><strong>1. 最简单的 <code>Ws</code> 提供者初始化方式</strong></h4><p>首先在 <code>Cargo.toml</code> 中启用 <code>ethers</code> 的 <code>ws</code> 特性</p>
<pre class="line-numbers language-toml"><code class="language-toml">ethers =  { version = "2.0.14", features = ["ws"] }<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>与其他提供者类似，可以直接通过 <code>Provider::&lt;Ws&gt;::connect()</code> 进行连接：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Provider<span class="token punctuation">,</span> Ws<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Ws<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"wss://..."</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h4 id="2-使用授权信息建立-WebSocket-连接"><a href="#2-使用授权信息建立-WebSocket-连接" class="headerlink" title="2. 使用授权信息建立 WebSocket 连接"></a><strong>2. 使用授权信息建立 WebSocket 连接</strong></h4><p>如果节点需要身份验证，你可以使用 <code>Authorization::basic(username, password)</code> 进行连接：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Authorization<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> Ws<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">"wss://..."</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> auth <span class="token operator">=</span> Authorization<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">basic</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Ws<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect_with_auth</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="2-基本用法"><a href="#2-基本用法" class="headerlink" title="2.基本用法"></a><strong>2.基本用法</strong></h3><p><code>Ws</code> 提供者可以像其他 <code>Provider</code> 一样向节点发送请求。此外，它还能<strong>订阅新区块、监听事件、监视交易池（mempool）等实时数据流</strong>。</p>
<h4 id="订阅新区块和挂起交易"><a href="#订阅新区块和挂起交易" class="headerlink" title="订阅新区块和挂起交易"></a><strong>订阅新区块和挂起交易</strong></h4><p>下面的示例展示了如何创建一个 <code>Ws</code> 提供者，并在两个独立的异步任务中：</p>
<ol>
<li>订阅 <code>mempool</code> 中的待确认交易</li>
<li>订阅新的区块头信息</li>
</ol>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! `Ws` 传输允许你通过 WebSocket 发送 JSON-RPC 请求并接收响应。</span>
<span class="token comment" spellcheck="true">//! 这使得可以实时与以太坊网络交互，而无需 HTTP 轮询。</span>

<span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> WSS_URL<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str <span class="token operator">=</span> <span class="token string">"wss://mainnet.infura.io/ws/v3/YOUR_INFURA_PROJECT_ID"</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 通过 WebSocket 连接创建 Provider</span>
    <span class="token comment" spellcheck="true">// 如果使用 wss，需要在 `Cargo.toml` 中启用 "rustls" 或 "openssl"</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Ws<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>WSS_URL<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 订阅新区块，仅获取一个块（`.take(1)` 限制只获取 1 个）</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stream <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">subscribe_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"新区块哈希: {:?}"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a><strong>3.总结</strong></h3><ul>
<li><code>Ws</code> 提供者使用 <code>WebSocket</code> 连接到以太坊节点，支持实时数据流。</li>
<li>你可以使用 <code>Provider::&lt;Ws&gt;::connect()</code> 进行连接，或者使用 <code>connect_with_auth()</code> 进行授权连接。</li>
<li><code>WebSocket</code> 允许订阅事件，例如新区块、待确认交易等，而无需 HTTP 轮询，提高了性能和响应速度。</li>
<li>在 <code>Cargo.toml</code> 需要启用 <code>"ws"</code> 以及 <code>"rustls"</code> 或 <code>"openssl"</code> 以确保 <code>WebSocket</code> 连接可用。</li>
</ul>
<h2 id="IPC-提供者（IPC-Provider）"><a href="#IPC-提供者（IPC-Provider）" class="headerlink" title="IPC 提供者（IPC Provider）"></a><strong>IPC 提供者（IPC Provider）</strong></h2><p><code>IPC（Inter-Process Communication，进程间通信）</code> 传输方式允许程序通过本地的 <strong>Unix 域套接字（Unix domain socket）</strong> 或 <strong>Windows 命名管道（Windows named pipe）</strong> 与以太坊节点进行通信。</p>
<p><code>IPC</code> 传输方式的 <strong>优点</strong>：</p>
<ul>
<li>允许 <code>ethers</code> 库向本地以太坊客户端发送 <strong>JSON-RPC</strong> 请求并接收响应 <strong>（无需网络连接或 HTTP 服务器）</strong>。</li>
<li>适用于<strong>运行在同一台机器上的本地区块链节点</strong>。</li>
<li><strong>比 HTTP RPC 更快</strong>，因为省去了网络传输的开销。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>只能用于本地节点，无法与远程服务器交互。</li>
</ul>
<hr>
<h3 id="1-初始化-IPC-提供者"><a href="#1-初始化-IPC-提供者" class="headerlink" title="1.初始化 IPC 提供者"></a><strong>1.初始化 IPC 提供者</strong></h3><p>根据操作系统的不同，<code>IPC</code> 连接方式有所不同：</p>
<ul>
<li><strong>Linux/macOS</strong> 使用 <code>Unix domain socket</code></li>
<li><strong>Windows</strong> 使用 <code>Named pipe</code></li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span>Provider<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 适用于 UNIX 系统（Linux/macOS）：连接本地 Geth 节点的 IPC 文件</span>
    <span class="token attribute attr-name">#[cfg(unix)]</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect_ipc</span><span class="token punctuation">(</span><span class="token string">"~/.ethereum/geth.ipc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 适用于 Windows 系统：连接本地 Geth 节点的命名管道</span>
    <span class="token attribute attr-name">#[cfg(windows)]</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect_ipc</span><span class="token punctuation">(</span><span class="token string">r"\\.\pipe\geth"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>connect_ipc()</code> 方法会尝试连接本地运行的以太坊节点（如 Geth）。</li>
<li>IPC 文件路径因客户端不同而不同：<ul>
<li><strong>Geth</strong>：<code>~/.ethereum/geth.ipc</code>（Linux/macOS）</li>
<li><strong>Erigon</strong>：<code>~/.local/share/erigon.ipc</code></li>
<li><strong>Windows</strong> 可能需要管理员权限才能访问管道。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-基本用法-1"><a href="#2-基本用法-1" class="headerlink" title="2.基本用法"></a><strong>2.基本用法</strong></h3><p><code>IPC</code> 提供者与 <code>Ws</code>类似，同时实现了：</p>
<ul>
<li><code>JsonRpcClient</code>（发送 JSON-RPC 请求）</li>
<li>``PubsubClient`（订阅事件）</li>
</ul>
<h4 id="示例：监听-UniswapV2-WETH-USDC-交易对储备变化"><a href="#示例：监听-UniswapV2-WETH-USDC-交易对储备变化" class="headerlink" title="示例：监听 UniswapV2 WETH/USDC 交易对储备变化"></a><strong>示例：监听 UniswapV2 WETH/USDC 交易对储备变化</strong></h4><p>此示例会：</p>
<ol>
<li>连接本地 IPC 节点</li>
<li>订阅以太坊新区块</li>
<li>监听 <strong>UniswapV2 WETH/USDC 交易对</strong> 的 <code>getReserves()</code> 数据</li>
<li><strong>当储备发生变化时打印日志</strong></li>
</ol>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! IPC（进程间通信）传输方式允许程序通过本地 Unix 域套接字或 Windows 命名管道与节点通信。</span>
<span class="token comment" spellcheck="true">//! 该方式比 HTTP RPC 更快，并且适用于本地以太坊节点。</span>

<span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Arc<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 生成智能合约接口</span>
<span class="token function">abigen!</span><span class="token punctuation">(</span>
    IUniswapV2Pair<span class="token punctuation">,</span>
    <span class="token string">"[function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)]"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 连接本地以太坊节点（Geth）</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect_ipc</span><span class="token punctuation">(</span><span class="token string">"~/.ethereum/geth.ipc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// WETH/USDC 交易对的 Uniswap V2 合约地址（主网）</span>
    <span class="token keyword">let</span> pair_address<span class="token punctuation">:</span> Address <span class="token operator">=</span> <span class="token string">"0xb4e16d0168e52d35cacd2c6185b44281ec28c9dc"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> weth_usdc <span class="token operator">=</span> IUniswapV2Pair<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>pair_address<span class="token punctuation">,</span> provider<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 获取当前区块号</span>
    <span class="token keyword">let</span> block <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"当前区块: {block}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 获取初始的储备数据</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> initial_reserves <span class="token operator">=</span> weth_usdc<span class="token punctuation">.</span><span class="token function">get_reserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"初始储备: {initial_reserves:?}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 订阅新区块</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stream <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">subscribe_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"新区块: {:?}"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 查询最新储备</span>
        <span class="token keyword">let</span> reserves <span class="token operator">=</span> weth_usdc<span class="token punctuation">.</span><span class="token function">get_reserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
        <span class="token keyword">if</span> reserves <span class="token operator">!=</span> initial_reserves <span class="token punctuation">{</span>
            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"储备发生变化: 旧 {initial_reserves:?} -> 新 {reserves:?}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initial_reserves <span class="token operator">=</span> reserves<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="3-总结-1"><a href="#3-总结-1" class="headerlink" title="3.总结"></a><strong>3.总结</strong></h3><ul>
<li><p><strong>IPC 提供者（IPC Provider）</strong></p>
<ul>
<li>通过 <strong>Unix 域套接字（Linux/macOS）</strong> 或 <strong>Windows 命名管道（Windows）</strong> 与本地以太坊节点通信。</li>
<li><strong>比 HTTP RPC 更快</strong>，适用于本地节点交互，不适用于远程服务器。</li>
</ul>
</li>
<li><p><strong>如何使用？</strong></p>
<ul>
<li><p>连接 <code>Geth</code> 节点：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect_ipc</span><span class="token punctuation">(</span><span class="token string">"~/.ethereum/geth.ipc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>订阅新区块：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> stream <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">subscribe_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>监听 UniswapV2 交易对的 <code>getReserves()</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> reserves <span class="token operator">=</span> weth_usdc<span class="token punctuation">.</span><span class="token function">get_reserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p><strong>适用场景</strong></p>
<ul>
<li>适用于 <strong>本地节点</strong>，如 Geth、Erigon、Nethermind。</li>
<li><strong>性能更高</strong>，比 HTTP RPC 速度快。</li>
<li>适用于<strong>监控交易池、交易数据、DApp 本地交互</strong>。</li>
</ul>
</li>
</ul>
<p>如果你需要 <strong>高性能、低延迟的以太坊节点通信</strong>，IPC 连接是一个很好的选择</p>
<h2 id="Mock-提供者（Mock-Provider）"><a href="#Mock-提供者（Mock-Provider）" class="headerlink" title="Mock 提供者（Mock Provider）"></a>Mock 提供者（Mock Provider）</h2><p><code>MockProvider</code> 是一个<strong>模拟以太坊提供者</strong>，可用于<strong>测试目的</strong>。它允许开发者<strong>模拟以太坊的状态和行为</strong>，并明确控制客户端请求的响应。</p>
<h3 id="1-为什么使用-MockProvider？"><a href="#1-为什么使用-MockProvider？" class="headerlink" title="1.为什么使用 MockProvider？"></a><strong>1.为什么使用 <code>MockProvider</code>？</strong></h3><ul>
<li><strong>不需要连接真实以太坊网络</strong>，也不需要消耗真实的 ETH 进行测试。</li>
<li><strong>可控、可预测</strong>：开发者可以<strong>控制提供者的状态和行为</strong>，让测试具有<strong>确定性</strong>。</li>
<li><strong>适用于依赖提供者的代码测试</strong>，如合约交互、区块链数据查询等。</li>
</ul>
<h3 id="2-测试模式-示例中采用-AAA（Arrange-Act-Assert）测试模式："><a href="#2-测试模式-示例中采用-AAA（Arrange-Act-Assert）测试模式：" class="headerlink" title="2.测试模式 示例中采用 AAA（Arrange, Act, Assert）测试模式："></a><strong>2.测试模式</strong> 示例中采用 <strong>AAA（Arrange, Act, Assert）测试模式</strong>：</h3><ul>
<li><strong>Arrange（准备）</strong>：初始化 <code>MockProvider</code>，设置测试数据。</li>
<li><strong>Act（执行）</strong>：调用被测试代码。</li>
<li><strong>Assert（断言）</strong>：验证返回值是否符合预期。</li>
</ul>
<hr>
<h3 id="3-示例-1：模拟区块号"><a href="#3-示例-1：模拟区块号" class="headerlink" title="3.示例 1：模拟区块号"></a><strong>3.示例 1：模拟区块号</strong></h3><p>该示例展示了如何使用 <code>MockProvider</code> 模拟区块号，并测试 <code>eth_blockNumber</code> 的返回值是否符合预期。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">mocked_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">mocked_provider_dependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

async <span class="token keyword">fn</span> <span class="token function">mocked_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// **Arrange（准备）：创建 MockProvider 并推送模拟的区块号**</span>
    <span class="token keyword">let</span> mock <span class="token operator">=</span> MockProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> block_num_1 <span class="token operator">=</span> U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> block_num_2 <span class="token operator">=</span> U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> block_num_3 <span class="token operator">=</span> U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Mock 数据是**后进先出（LIFO）**</span>
    mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>block_num_1<span class="token punctuation">)</span>?<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 最后一个被调用</span>
    mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>block_num_2<span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>block_num_3<span class="token punctuation">)</span>?<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 最先被调用</span>

    <span class="token comment" spellcheck="true">// **Act（执行）：请求区块号**</span>
    <span class="token keyword">let</span> ret_block_3<span class="token punctuation">:</span> U64 <span class="token operator">=</span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock<span class="token punctuation">,</span> <span class="token string">"eth_blockNumber"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> ret_block_2<span class="token punctuation">:</span> U64 <span class="token operator">=</span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock<span class="token punctuation">,</span> <span class="token string">"eth_blockNumber"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> ret_block_1<span class="token punctuation">:</span> U64 <span class="token operator">=</span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock<span class="token punctuation">,</span> <span class="token string">"eth_blockNumber"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **Assert（断言）：检查返回值**</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>block_num_1<span class="token punctuation">,</span> ret_block_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>block_num_2<span class="token punctuation">,</span> ret_block_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>block_num_3<span class="token punctuation">,</span> ret_block_3<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>📌 关键点</strong></p>
<ul>
<li><strong>使用 <code>mock.push()</code> 预设数据</strong>，数据按照 <strong>LIFO（后进先出）</strong> 方式返回。</li>
<li><strong><code>JsonRpcClient::request()</code> 发送请求</strong>，返回的区块号应与 <code>mock.push()</code> 设定的顺序匹配。</li>
</ul>
<hr>
<h3 id="4-示例-2：测试依赖提供者的代码"><a href="#4-示例-2：测试依赖提供者的代码" class="headerlink" title="4.示例 2：测试依赖提供者的代码"></a><strong>4.示例 2：测试依赖提供者的代码</strong></h3><p>此示例测试 <strong><code>OddBlockOracle</code> 结构体</strong>，它依赖 <code>Provider</code> 进行区块号判断。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// **测试 `OddBlockOracle`，它依赖于 `Provider`**</span>
<span class="token comment" spellcheck="true">/// `Provider` 的引用通过 trait bounds 进行表达，使代码保持松耦合、可维护性和可测试性。</span>

async <span class="token keyword">fn</span> <span class="token function">mocked_provider_dependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// **Arrange（准备）：创建模拟 Provider**</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>provider<span class="token punctuation">,</span> mock<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">mocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 预设区块号 2</span>

    <span class="token comment" spellcheck="true">// **Act（执行）：创建 OddBlockOracle 并检查区块号是否为奇数**</span>
    <span class="token keyword">let</span> oracle <span class="token operator">=</span> OddBlockOracle<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> answer<span class="token punctuation">:</span> bool <span class="token operator">=</span> oracle<span class="token punctuation">.</span><span class="token function">is_odd_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **Assert（断言）：由于区块号是 2（偶数），应返回 `true`**</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong><code>OddBlockOracle</code> 结构体</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// `OddBlockOracle` 依赖 `Provider`，用于判断当前区块号是否为奇数</span>
<span class="token keyword">struct</span> OddBlockOracle<span class="token operator">&lt;</span>P<span class="token operator">></span> <span class="token punctuation">{</span>
    provider<span class="token punctuation">:</span> Provider<span class="token operator">&lt;</span>P<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>P<span class="token operator">></span> OddBlockOracle<span class="token operator">&lt;</span>P<span class="token operator">></span>
<span class="token keyword">where</span>
    P<span class="token punctuation">:</span> JsonRpcClient<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// `P` 必须实现 `JsonRpcClient`</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>provider<span class="token punctuation">:</span> Provider<span class="token operator">&lt;</span>P<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        Self <span class="token punctuation">{</span> provider <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// **被测试的方法：判断区块号是否为奇数**</span>
    async <span class="token keyword">fn</span> <span class="token function">is_odd_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span>bool<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> block<span class="token punctuation">:</span> U64 <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>provider<span class="token punctuation">.</span><span class="token function">get_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>block <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 偶数返回 true，奇数返回 false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong><code>OddBlockOracle</code> 依赖 <code>Provider</code>，但 <code>Provider</code> 是通过 trait 绑定传递的</strong>，这样代码更松耦合、可维护性更高。</li>
<li><strong>使用 <code>mock.push(U64::from(2))</code> 预设区块号</strong>，确保 <code>is_odd_block()</code> 返回 <code>true</code>。</li>
<li><strong>依赖注入（DI）</strong>：通过 <code>Provider&lt;P&gt;</code> 传递 <code>MockProvider</code>，使得 <code>OddBlockOracle</code> <strong>无需直接与 MockProvider 耦合</strong>，提高了可测试性。</li>
</ul>
<hr>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a><strong>5.总结</strong></h3><p><strong><code>MockProvider</code> 的特点</strong></p>
<ul>
<li><strong>无需连接真实以太坊网络</strong>，适用于测试。</li>
<li><strong>可控的区块链状态</strong>，确保测试可预测、可重复。</li>
<li><strong>LIFO（后进先出）</strong> 机制，模拟 JSON-RPC 响应。</li>
</ul>
<p><strong>如何使用？</strong></p>
<ol>
<li><p>创建 <code>MockProvider</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> mock <span class="token operator">=</span> MockProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>预设返回值（LIFO 方式）：</p>
<pre class="line-numbers language-rust"><code class="language-rust">mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
mock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>调用 <code>JsonRpcClient::request()</code> 测试返回值：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> block<span class="token punctuation">:</span> U64 <span class="token operator">=</span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock<span class="token punctuation">,</span> <span class="token string">"eth_blockNumber"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>测试依赖 <code>Provider</code> 的代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token punctuation">(</span>provider<span class="token punctuation">,</span> mock<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">mocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<p><strong>适用场景</strong></p>
<ul>
<li><strong>测试 JSON-RPC 交互</strong>（如 <code>eth_blockNumber</code>）。</li>
<li><strong>测试依赖 <code>Provider</code> 的代码</strong>（如 <code>OddBlockOracle</code>）。</li>
<li><strong>确保测试</strong> <strong>可预测</strong>、<strong>可重复执行</strong>、<strong>不依赖真实网络</strong>。</li>
</ul>
<hr>
<p> <code>MockProvider</code> 是 <code>ethers-rs</code> 中一个<strong>强大的测试工具</strong>，它可以让开发者<strong>在本地高效测试区块链应用</strong>，避免真实网络带来的<strong>不确定性</strong>。如果你需要对 <strong>智能合约交互、链上数据查询</strong> 进行 <strong>单元测试</strong>，<code>MockProvider</code> 是一个<strong>理想的选择</strong>！</p>
<h2 id="Quorum-提供者（Quorum-Provider）"><a href="#Quorum-提供者（Quorum-Provider）" class="headerlink" title="Quorum 提供者（Quorum Provider）"></a><strong>Quorum 提供者（Quorum Provider）</strong></h2><p><code>QuorumProvider</code> 是 <code>ethers-rs</code> 提供的一种特殊的以太坊 RPC 提供者，它<strong>会向多个后端发送请求，并且只有在达到设定的“法定人数”（Quorum）时才会返回值</strong>。</p>
<hr>
<h3 id="1-为什么使用-QuorumProvider？"><a href="#1-为什么使用-QuorumProvider？" class="headerlink" title="1.为什么使用 QuorumProvider？"></a><strong>1.为什么使用 <code>QuorumProvider</code>？</strong></h3><ol>
<li><strong>提高可靠性</strong>：如果某个 RPC 节点宕机，<code>QuorumProvider</code> 仍能从其他可用的 RPC 提供者获取数据。</li>
<li><strong>增强数据一致性</strong>：通过多个数据源交叉验证，避免依赖单个 RPC 提供者可能带来的错误信息。</li>
<li><strong>支持权重机制</strong>：不同的 RPC 提供者可以设置不同的权重，某些提供者的响应可以有更大的影响力。</li>
</ol>
<hr>
<h3 id="2-示例：使用-QuorumProvider-进行-RPC-交叉验证"><a href="#2-示例：使用-QuorumProvider-进行-RPC-交叉验证" class="headerlink" title="2.示例：使用 QuorumProvider 进行 RPC 交叉验证"></a><strong>2.示例：使用 <code>QuorumProvider</code> 进行 RPC 交叉验证</strong></h3><p>下面的代码展示了如何创建 <code>QuorumProvider</code>，并通过多个 RPC 提供者来获取账户列表。</p>
<pre><code>use ethers::{
    core::utils::Anvil,
    providers::{Http, Middleware, Provider, Quorum, QuorumProvider, WeightedProvider, Ws},
};
use eyre::Result;
use std::{str::FromStr, time::Duration};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    // 启动本地 Anvil 以太坊测试节点
    let anvil = Anvil::new().spawn();

    // **创建 QuorumProvider，并添加多个 RPC 提供者**
    let quorum = QuorumProvider::dyn_rpc()
        .add_provider(WeightedProvider::new(Box::new(Http::from_str(&amp;anvil.endpoint())?))) // HTTP 提供者
        .add_provider(WeightedProvider::with_weight(
            Box::new(Ws::connect(anvil.ws_endpoint()).await?),
            2, // WebSocket 提供者，权重为 2
        ))
        .add_provider(WeightedProvider::with_weight(
            Box::new(Ws::connect(anvil.ws_endpoint()).await?),
            2, // 另一个 WebSocket 提供者，权重为 2
        ))
        // **设置法定人数（Quorum），当超过 50% 的提供者返回相同的值时，才接受数据**
        .quorum(Quorum::Majority)
        .build();

    // **使用 QuorumProvider 创建 Provider**
    let provider = Provider::quorum(quorum).interval(Duration::from_millis(10));

    // **查询账户列表**
    let _ = provider.get_accounts().await?;

    Ok(())
}</code></pre><hr>
<p><strong>代码解析:</strong></p>
<ol>
<li><strong>创建 <code>QuorumProvider</code></strong><ul>
<li><code>QuorumProvider::dyn_rpc()</code>：创建一个动态 RPC 提供者集合。</li>
<li><code>add_provider(WeightedProvider::new(...))</code>：向 <code>QuorumProvider</code> 添加一个 HTTP RPC 提供者。</li>
<li><code>add_provider(WeightedProvider::with_weight(..., 2))</code>：<ul>
<li>添加一个 WebSocket RPC 提供者，权重为 <strong>2</strong>（意味着该提供者的影响力是普通提供者的 <strong>2 倍</strong>）。</li>
</ul>
</li>
<li><code>.quorum(Quorum::Majority)</code>：<ul>
<li>设定法定人数为 <strong>Majority（多数派）</strong>，即超过 50% 的 RPC 提供者返回相同的值，才会接受该值。</li>
</ul>
</li>
</ul>
</li>
<li><strong>使用 <code>Provider::quorum()</code> 进行 RPC 交叉验证</strong><ul>
<li><code>Provider::quorum(quorum)</code>：使用 <code>QuorumProvider</code> 创建 <code>Provider</code>。</li>
<li><code>.interval(Duration::from_millis(10))</code>：设置请求间隔 <strong>10ms</strong>，以减少请求频率。</li>
</ul>
</li>
<li><strong>执行 RPC 请求</strong><ul>
<li><code>provider.get_accounts().await?</code>：获取账户列表。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="3-适用场景"><a href="#3-适用场景" class="headerlink" title="3.适用场景:"></a>3.适用场景:</h3><ul>
<li><strong>提高数据可靠性</strong>：防止因单个 RPC 提供者故障导致数据不可用。</li>
<li><strong>增强数据一致性</strong>：多个 RPC 交叉验证，避免错误信息。</li>
<li><strong>负载均衡</strong>：可以为不同的 RPC 提供者分配不同的权重。</li>
<li><strong>适用于高可用性应用</strong>：DApp、交易平台等需要稳定数据源的应用。</li>
</ul>
<hr>
<h3 id="4-结论"><a href="#4-结论" class="headerlink" title="4.结论"></a><strong>4.结论</strong></h3><ul>
<li><code>QuorumProvider</code> <strong>允许使用多个 RPC 提供者来提高可靠性和数据一致性</strong>。</li>
<li><strong>通过“法定人数”（Quorum）机制</strong>，确保数据在多个提供者之间达成共识后才被接受。</li>
<li><strong>适用于高可用性、低延迟的应用场景</strong>，如 <strong>DApp、交易平台、链上分析工具</strong> 等。</li>
</ul>
<p><strong>如果你希望以更稳定、更可靠的方式获取区块链数据，<code>QuorumProvider</code> 是一个不错的选择！</strong></p>
<h2 id="重试客户端（Retry-Client）"><a href="#重试客户端（Retry-Client）" class="headerlink" title="重试客户端（Retry Client）"></a><strong>重试客户端（Retry Client）</strong></h2><p><code>RetryClient</code> 是 <code>ethers-rs</code> 提供的 <strong>JSON-RPC 客户端包装器</strong>，它会<strong>自动重试失败的请求</strong>，并采用<strong>指数退避（exponential backoff）</strong>策略，同时根据 <strong>RetryPolicy</strong> 进行过滤。</p>
<h3 id="1-为什么使用-RetryClient？"><a href="#1-为什么使用-RetryClient？" class="headerlink" title="1.为什么使用 RetryClient？"></a><strong>1.为什么使用 <code>RetryClient</code>？</strong></h3><p> <strong>1.自动重试失败的请求</strong>，特别是：</p>
<ul>
<li><strong>因速率限制（Rate Limiting）导致的错误</strong>。</li>
<li><strong>因网络连接问题（如超时）导致的错误</strong>。</li>
<li><strong>服务器返回 5xx 错误时</strong>。</li>
</ul>
<p><strong>2.可定制化</strong>：</p>
<ul>
<li><p><strong><code>RetryPolicy</code></strong> 允许开发者根据不同应用需求调整重试策略。</p>
</li>
<li><p><strong>支持不同类型的错误处理</strong>，比如速率限制错误、网络超时等。</p>
<p><strong>3.提升网络请求的稳定性</strong>：</p>
</li>
<li><p><strong>指数退避（Exponential Backoff）</strong> 避免短时间内大量请求失败，提高 API 调用成功率。</p>
</li>
</ul>
<hr>
<h3 id="2-示例：使用-RetryClient-进行区块查询"><a href="#2-示例：使用-RetryClient-进行区块查询" class="headerlink" title="2.示例：使用 RetryClient 进行区块查询"></a><strong>2.示例：使用 <code>RetryClient</code> 进行区块查询</strong></h3><p>下面的代码展示了如何使用 <code>RetryClient</code>，在 <strong>JSON-RPC 请求失败时自动重试</strong>。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> reqwest<span class="token punctuation">:</span><span class="token punctuation">:</span>Url<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>time<span class="token punctuation">:</span><span class="token punctuation">:</span>Duration<span class="token punctuation">;</span>

<span class="token keyword">const</span> RPC_URL<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// **创建一个 HTTP Provider**</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span>RPC_URL<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **使用 `RetryClientBuilder` 构建 `RetryClient`**</span>
    <span class="token keyword">let</span> client <span class="token operator">=</span> RetryClientBuilder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">rate_limit_retries</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 速率限制错误时，最多重试 10 次</span>
        <span class="token punctuation">.</span><span class="token function">timeout_retries</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 网络超时时，最多重试 3 次</span>
        <span class="token punctuation">.</span><span class="token function">initial_backoff</span><span class="token punctuation">(</span>Duration<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 初始退避时间 500ms</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span>HttpRateLimitRetryPolicy<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **发送 JSON-RPC 请求，查询最新区块**</span>
    <span class="token keyword">let</span> block_num <span class="token operator">=</span> <span class="token string">"latest"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> txn_details <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">(</span>block_num<span class="token punctuation">,</span> txn_details<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> block<span class="token punctuation">:</span> Block<span class="token operator">&lt;</span>H256<span class="token operator">></span> <span class="token operator">=</span>
        JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span> <span class="token string">"eth_getBlockByNumber"</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{block:?}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p><strong>代码解析</strong></p>
<ol>
<li><p><strong>创建 HTTP 提供者</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> provider <span class="token operator">=</span> Http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span>RPC_URL<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>这里使用 <code>Http::new()</code> 创建了一个 <strong>普通 HTTP JSON-RPC 提供者</strong>。</li>
</ul>
</li>
<li><p><strong>创建 <code>RetryClient</code></strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> client <span class="token operator">=</span> RetryClientBuilder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">rate_limit_retries</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 遇到速率限制错误时，最多重试 10 次</span>
    <span class="token punctuation">.</span><span class="token function">timeout_retries</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 发生网络超时时，最多重试 3 次</span>
    <span class="token punctuation">.</span><span class="token function">initial_backoff</span><span class="token punctuation">(</span>Duration<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 初始指数退避时间 500ms</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span>HttpRateLimitRetryPolicy<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>RetryClientBuilder::default()</code>：创建 <strong>重试客户端构造器</strong>。</li>
<li><code>.rate_limit_retries(10)</code>：如果请求因速率限制（Rate Limit）失败，最多重试 <strong>10 次</strong>。</li>
<li><code>.timeout_retries(3)</code>：如果请求因 <strong>网络超时</strong> 失败，最多重试 <strong>3 次</strong>。</li>
<li><code>.initial_backoff(Duration::from_millis(500))</code>：<ul>
<li>初始<strong>指数退避时间</strong>（<code>Exponential Backoff</code>），即：</li>
<li><strong>第一次重试后等待 500ms</strong>，<strong>第二次 1000ms</strong>，<strong>第三次 2000ms</strong>，以此类推。</li>
</ul>
</li>
<li><code>.build(provider, Box::&lt;ethers::providers::HttpRateLimitRetryPolicy&gt;::default())</code>：<ul>
<li>使用 <code>HttpRateLimitRetryPolicy</code> <strong>自动处理速率限制错误</strong>。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>发送 <code>eth_getBlockByNumber</code> 请求</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> block_num <span class="token operator">=</span> <span class="token string">"latest"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> txn_details <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">(</span>block_num<span class="token punctuation">,</span> txn_details<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> block<span class="token punctuation">:</span> Block<span class="token operator">&lt;</span>H256<span class="token operator">></span> <span class="token operator">=</span>
    JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span> <span class="token string">"eth_getBlockByNumber"</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>请求获取<strong>最新区块信息</strong>，如果失败，会按照 <strong>指数退避策略</strong> 进行 <strong>重试</strong>。</li>
</ul>
</li>
<li><p><strong>输出查询到的区块信息</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{block:?}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<h3 id="3-适用场景-1"><a href="#3-适用场景-1" class="headerlink" title="3.适用场景"></a>3.适用场景</h3><p> <strong>区块链应用高可用性</strong></p>
<ul>
<li><p>例如 DeFi 平台、DApp 后端，需要长期运行并确保数据稳定获取。</p>
<p><strong>减少速率限制带来的问题</strong></p>
</li>
<li><p>许多以太坊 RPC 提供者（如 Infura、Alchemy）<strong>对每秒请求次数有限制</strong>，<code>RetryClient</code> 能够帮助处理这种情况。</p>
<p><strong>处理临时性网络问题</strong></p>
</li>
<li><p><strong>自动重试连接超时的请求</strong>，无需手动管理错误。</p>
<p><strong>提升 API 请求的成功率</strong></p>
</li>
<li><p>使用指数退避（Exponential Backoff）<strong>减少 API 服务器的负载</strong>，避免过多无效请求。</p>
</li>
</ul>
<hr>
<h3 id="4-结论-1"><a href="#4-结论-1" class="headerlink" title="4.结论"></a>4.结论</h3><ul>
<li><code>RetryClient</code> 是 <strong>一个增强版的 JSON-RPC 客户端</strong>，用于自动重试失败的请求。</li>
<li><strong>指数退避策略</strong> 确保重试间隔逐步增加，避免过度请求 API。</li>
<li><strong>支持速率限制、网络超时、服务器错误</strong> 等场景，提高 API 请求的稳定性。</li>
<li><strong>适用于高可用性区块链应用</strong>，如 <strong>DApp、DeFi 平台、链上数据分析工具</strong>。</li>
</ul>
<p>如果你在希望提升 JSON-RPC 请求的稳定性，<code>RetryClient</code> 是一个非常有用的工具！</p>
<h2 id="RW-提供者（RW-Provider）"><a href="#RW-提供者（RW-Provider）" class="headerlink" title="RW 提供者（RW Provider）"></a><strong>RW 提供者（RW Provider）</strong></h2><p><code>RwClient</code> 是 <code>ethers-rs</code> 提供的 <strong>JSON-RPC 客户端包装器</strong>，它封装了两种不同的数据传输方式：一种用于读取操作，另一种用于写入操作，后者会消耗类似于发送交易的 Gas。</p>
<h3 id="1-为什么使用-RwClient？"><a href="#1-为什么使用-RwClient？" class="headerlink" title="1.为什么使用 RwClient？"></a><strong>1.为什么使用 <code>RwClient</code>？</strong></h3><p><strong>1.处理读取与写入操作的分离：</strong></p>
<ul>
<li><code>RwClient</code> 提供了 <strong>分开的读写数据通道</strong>，通过这种方式可以分别处理读取操作和写入操作。</li>
<li>读取操作通过 HTTP 连接进行，而写入操作通过 WebSocket 连接进行。</li>
</ul>
<p><strong>2.提高操作的效率：</strong></p>
<ul>
<li><strong>分别使用 HTTP 和 WebSocket</strong> 连接，确保数据传输在不同操作时的效率。</li>
<li>可以更好地控制读取与写入操作，特别是当它们有不同的需求时。</li>
</ul>
<hr>
<h3 id="2-示例：使用-RwClient-连接区块链网络"><a href="#2-示例：使用-RwClient-连接区块链网络" class="headerlink" title="2.示例：使用 RwClient 连接区块链网络"></a><strong>2.示例：使用 <code>RwClient</code> 连接区块链网络</strong></h3><p>下面的代码展示了如何使用 <code>RwClient</code>，同时进行读取和写入操作。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> utils<span class="token punctuation">:</span><span class="token punctuation">:</span>Anvil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> url<span class="token punctuation">:</span><span class="token punctuation">:</span>Url<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// **启动 Anvil 实例**</span>
    <span class="token keyword">let</span> anvil <span class="token operator">=</span> Anvil<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **解析 HTTP 端点并创建 HTTP 客户端**</span>
    <span class="token keyword">let</span> http_url <span class="token operator">=</span> Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>anvil<span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> http <span class="token operator">=</span> Http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>http_url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **连接 WebSocket 端点**</span>
    <span class="token keyword">let</span> ws <span class="token operator">=</span> Ws<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>anvil<span class="token punctuation">.</span><span class="token function">ws_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// **创建 RW Provider**</span>
    <span class="token keyword">let</span> _provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">rw</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p><strong>代码解析</strong></p>
<ol>
<li><p><strong>启动 Anvil 实例</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> anvil <span class="token operator">=</span> Anvil<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>通过 <code>Anvil::new().spawn()</code> 启动一个本地的区块链实例，用于模拟网络连接。</li>
</ul>
</li>
<li><p><strong>创建 HTTP 客户端</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> http_url <span class="token operator">=</span> Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>anvil<span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
<span class="token keyword">let</span> http <span class="token operator">=</span> Http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>http_url<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>通过 <code>Url::parse(&amp;anvil.endpoint())?</code> 解析 Anvil 提供的 HTTP 端点，并用其创建 HTTP 客户端。</li>
</ul>
</li>
<li><p><strong>连接 WebSocket 端点</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> ws <span class="token operator">=</span> Ws<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>anvil<span class="token punctuation">.</span><span class="token function">ws_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>通过 <code>Ws::connect()</code> 连接 Anvil 提供的 WebSocket 端点。</li>
</ul>
</li>
<li><p><strong>创建 RW Provider</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> _provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">rw</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>使用 <code>Provider::rw(http, ws)</code> 创建一个 <code>RwClient</code>，同时连接 HTTP 和 WebSocket 数据通道，用于处理读取和写入操作。</li>
</ul>
</li>
</ol>
<h3 id="3-适用场景-2"><a href="#3-适用场景-2" class="headerlink" title="3.适用场景"></a>3.适用场景</h3><p><strong>读写操作分离的区块链应用</strong></p>
<ul>
<li>适用于需要同时处理读取和写入操作的应用，如 <strong>区块链交易</strong> 和 <strong>数据查询</strong>。</li>
</ul>
<p><strong>提高效率和稳定性</strong></p>
<ul>
<li>通过分离不同类型的操作，<strong>读取操作和写入操作可以在不同的通道上高效运行</strong>，避免互相影响。</li>
</ul>
<hr>
<h3 id="4-结论-2"><a href="#4-结论-2" class="headerlink" title="4.结论"></a>4.结论</h3><ul>
<li><code>RwClient</code> 是 <strong>一个处理读写操作的增强版 JSON-RPC 客户端</strong>，通过分离 HTTP 和 WebSocket 连接，优化了区块链网络的数据传输。</li>
<li><strong>适用于区块链开发</strong>，尤其是在需要同时进行查询和交易时。</li>
<li>使用 <code>RwClient</code> 可以有效提高读写操作的效率与稳定性。</li>
</ul>
<p>如果你需要高效的 <strong>区块链数据传输</strong>，<code>RwClient</code> 是一个非常有用的工具！</p>
<h2 id="自定义数据传输（Custom-Data-Transport）"><a href="#自定义数据传输（Custom-Data-Transport）" class="headerlink" title="自定义数据传输（Custom Data Transport）"></a><strong>自定义数据传输（Custom Data Transport）</strong></h2><p>自定义数据传输允许我们根据需求实现一个符合 <strong><code>JsonRpcClient</code></strong> 接口的传输方式，并且可以选择性地实现 <strong><code>PubsubClient</code></strong>。以下展示了如何创建一个支持 <strong>WebSocket (Ws)</strong> 或 <strong>IPC</strong> 传输的自定义数据传输。</p>
<h3 id="1-为什么使用自定义数据传输？"><a href="#1-为什么使用自定义数据传输？" class="headerlink" title="1. 为什么使用自定义数据传输？"></a><strong>1. 为什么使用自定义数据传输？</strong></h3><p><strong>1.实现灵活的传输选择：</strong></p>
<ul>
<li>通过使用枚举类型（<code>WsOrIpc</code>），我们可以选择 WebSocket 或 IPC 作为数据传输方式，具体选择取决于实际情况。</li>
</ul>
<p><strong>2.支持多种通信协议：</strong></p>
<ul>
<li>可以将 WebSocket 和 IPC 作为两种独立的传输方式，使得应用可以在不同的网络环境下灵活使用。</li>
</ul>
<p><strong>3.增加可扩展性：</strong></p>
<ul>
<li>可以根据需要轻松地扩展新的传输方式，只需要遵循 <code>JsonRpcClient</code> 和 <code>PubsubClient</code> 接口的规范。</li>
</ul>
<hr>
<h3 id="2-示例：实现自定义数据传输"><a href="#2-示例：实现自定义数据传输" class="headerlink" title="2.示例：实现自定义数据传输"></a><strong>2.示例：实现自定义数据传输</strong></h3><p>下面的代码展示了如何通过实现一个既支持 <strong>WebSocket</strong> 又支持 <strong>IPC</strong> 的自定义数据传输，来构建一个通用的 RPC 客户端。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! 创建一个自定义数据传输，以便与 Provider 一起使用。</span>

<span class="token keyword">use</span> async_trait<span class="token punctuation">:</span><span class="token punctuation">:</span>async_trait<span class="token punctuation">;</span>
<span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>core<span class="token punctuation">:</span><span class="token punctuation">:</span>utils<span class="token punctuation">:</span><span class="token punctuation">:</span>Anvil<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> serde<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>de<span class="token punctuation">:</span><span class="token punctuation">:</span>DeserializeOwned<span class="token punctuation">,</span> Serialize<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Debug<span class="token punctuation">;</span>
<span class="token keyword">use</span> thiserror<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token punctuation">;</span>
<span class="token keyword">use</span> url<span class="token punctuation">:</span><span class="token punctuation">:</span>Url<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/// 首先，我们需要创建一个错误类型，并为 [`ProviderError`] 实现 [`From`]。</span>
<span class="token comment" spellcheck="true">/// 这里我们使用 [`thiserror`](https://docs.rs/thiserror) 来包装 [`WsClientError`] 和 [`IpcError`]。</span>
<span class="token attribute attr-name">#[derive(Debug, Error)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> WsOrIpcError <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[error(transparent)]</span>
    <span class="token function">Ws</span><span class="token punctuation">(</span><span class="token attribute attr-name">#[from]</span> WsClientError<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[error(transparent)]</span>
    <span class="token function">Ipc</span><span class="token punctuation">(</span><span class="token attribute attr-name">#[from]</span> IpcError<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// 为了在 RPC 客户端中使用 `WsOrIpcError`，我们需要实现这个 trait。</span>
<span class="token keyword">impl</span> RpcError <span class="token keyword">for</span> WsOrIpcError <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">as_error_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Option<span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethers<span class="token punctuation">:</span><span class="token punctuation">:</span>providers<span class="token punctuation">:</span><span class="token punctuation">:</span>JsonRpcError<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            WsOrIpcError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> e<span class="token punctuation">.</span><span class="token function">as_error_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            WsOrIpcError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> e<span class="token punctuation">.</span><span class="token function">as_error_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function">as_serde_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Option<span class="token operator">&lt;</span><span class="token operator">&amp;</span>serde_json<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            WsOrIpcError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>WsClientError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">JsonError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">Some</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
            WsOrIpcError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>IpcError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">JsonError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">Some</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=</span><span class="token operator">></span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> From<span class="token operator">&lt;</span>WsOrIpcError<span class="token operator">></span> <span class="token keyword">for</span> ProviderError <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">from</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> WsOrIpcError<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">JsonRpcClientError</span><span class="token punctuation">(</span>Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// 创建我们的传输类型，这里我们使用枚举类型来存储 [`Ws`] 或 [`Ipc`]。</span>
<span class="token attribute attr-name">#[derive(Clone, Debug)]</span>
<span class="token keyword">enum</span> WsOrIpc <span class="token punctuation">{</span>
    <span class="token function">Ws</span><span class="token punctuation">(</span>Ws<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Ipc</span><span class="token punctuation">(</span>Ipc<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 提供一个便利的“构造器”方法，用于初始化传输。</span>
<span class="token keyword">impl</span> WsOrIpc <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> async <span class="token keyword">fn</span> <span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>Self<span class="token punctuation">,</span> WsOrIpcError<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> this <span class="token operator">=</span> <span class="token keyword">match</span> Url<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Ok</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>Ws<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>Ipc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 接下来，最重要的一步：实现 [`JsonRpcClient`]。</span>
<span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">impl</span> JsonRpcClient <span class="token keyword">for</span> WsOrIpc <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> WsOrIpcError<span class="token punctuation">;</span>

    async <span class="token keyword">fn</span> request<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">,</span> params<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>R<span class="token punctuation">,</span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span>
    <span class="token keyword">where</span>
        T<span class="token punctuation">:</span> Debug <span class="token operator">+</span> Serialize <span class="token operator">+</span> Send <span class="token operator">+</span> Sync<span class="token punctuation">,</span>
        R<span class="token punctuation">:</span> DeserializeOwned <span class="token operator">+</span> Send<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> method<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">,</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>ipc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span>ipc<span class="token punctuation">,</span> method<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 由于 `Ws` 和 `Ipc` 都实现了 [`PubsubClient`]，我们也可以实现它。</span>
<span class="token keyword">impl</span> PubsubClient <span class="token keyword">for</span> WsOrIpc <span class="token punctuation">{</span>
    <span class="token keyword">type</span> NotificationStream <span class="token operator">=</span> <span class="token operator">&lt;</span>Ws <span class="token keyword">as</span> PubsubClient<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>NotificationStream<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> subscribe<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Into<span class="token operator">&lt;</span>U256<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>NotificationStream<span class="token punctuation">,</span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stream <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PubsubClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">subscribe</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> id<span class="token punctuation">)</span>?<span class="token punctuation">,</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>ipc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PubsubClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">subscribe</span><span class="token punctuation">(</span>ipc<span class="token punctuation">,</span> id<span class="token punctuation">)</span>?<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> unsubscribe<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Into<span class="token operator">&lt;</span>U256<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PubsubClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> id<span class="token punctuation">)</span>?<span class="token punctuation">,</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>ipc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PubsubClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>ipc<span class="token punctuation">,</span> id<span class="token punctuation">)</span>?<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 启动 Anvil 实例</span>
    <span class="token keyword">let</span> anvil <span class="token operator">=</span> Anvil<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block_time</span><span class="token punctuation">(</span><span class="token number">1u64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 连接到自定义传输</span>
    <span class="token keyword">let</span> transport <span class="token operator">=</span> WsOrIpc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>anvil<span class="token punctuation">.</span><span class="token function">ws_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 将传输包装在 Provider 中</span>
    <span class="token keyword">let</span> provider <span class="token operator">=</span> Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 现在可以像正常使用 Provider 一样使用我们的自定义传输</span>
    <span class="token keyword">let</span> block_number <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"当前区块：{block_number}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> subscription <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">subscribe_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token operator">=</span> subscription<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"新区块： {:?}"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p><strong>代码解析</strong></p>
<ol>
<li><p><strong>创建错误类型</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Error)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> WsOrIpcError <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[error(transparent)]</span>
    <span class="token function">Ws</span><span class="token punctuation">(</span><span class="token attribute attr-name">#[from]</span> WsClientError<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[error(transparent)]</span>
    <span class="token function">Ipc</span><span class="token punctuation">(</span><span class="token attribute attr-name">#[from]</span> IpcError<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>WsOrIpcError</code> 枚举用于封装 <code>WsClientError</code> 和 <code>IpcError</code> 错误，便于后续处理。</li>
</ul>
</li>
<li><p><strong>实现 <code>JsonRpcClient</code></strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">impl</span> JsonRpcClient <span class="token keyword">for</span> WsOrIpc <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> WsOrIpcError<span class="token punctuation">;</span>

    async <span class="token keyword">fn</span> request<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">,</span> params<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>R<span class="token punctuation">,</span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span>
    <span class="token keyword">where</span>
        T<span class="token punctuation">:</span> Debug <span class="token operator">+</span> Serialize <span class="token operator">+</span> Send <span class="token operator">+</span> Sync<span class="token punctuation">,</span>
        R<span class="token punctuation">:</span> DeserializeOwned <span class="token operator">+</span> Send<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ws</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> method<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">,</span>
            Self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ipc</span><span class="token punctuation">(</span>ipc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> JsonRpcClient<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">request</span><span class="token punctuation">(</span>ipc<span class="token punctuation">,</span> method<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>JsonRpcClient</code> 接口被实现为通过 WebSocket 或 IPC 传输进行请求。</li>
</ul>
</li>
<li><p><strong>创建自定义连接</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> transport <span class="token operator">=</span> WsOrIpc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>anvil<span class="token punctuation">.</span><span class="token function">ws_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>WsOrIpc::connect()</code> 方法根据传入的 URL 自动选择 WebSocket 或 IPC 连接方式。</li>
</ul>
</li>
</ol>
<h3 id="3-适用场景-3"><a href="#3-适用场景-3" class="headerlink" title="3.适用场景"></a>3.适用场景</h3><p><strong>灵活的传输方式选择</strong></p>
<ul>
<li>适用于需要在 WebSocket 和 IPC 之间切换的区块链应用，提供了灵活的数据传输方案。</li>
</ul>
<p><strong>增强的可扩展性</strong></p>
<ul>
<li>支持后续扩展其他传输协议，提供高可用的自定义传输能力。</li>
</ul>
<hr>
<h3 id="4-结论-3"><a href="#4-结论-3" class="headerlink" title="4.结论"></a>4.结论</h3><ul>
<li>通过实现自定义数据传输方式，开发者可以灵活选择使用 WebSocket 或 IPC。</li>
<li><code>JsonRpcClient</code> 和 <code>PubsubClient</code> 接口的实现确保了代码的可扩展性和高效性。</li>
<li>适用于需要高灵活性和可扩展性的区块链应用。</li>
</ul>
<h2 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a><strong>高级用法</strong></h2><h3 id="CallBuilder"><a href="#CallBuilder" class="headerlink" title="CallBuilder"></a><strong>CallBuilder</strong></h3><p><code>CallBuilder</code> 是一个枚举，用于帮助创建复杂的调用。它实现了 <code>RawCall</code> 方法，可以重写 <code>eth_call rpc</code> 方法的参数。我们来快速看一下如何使用 <code>CallBuilder</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Http<span class="token punctuation">,</span> Provider<span class="token punctuation">}</span><span class="token punctuation">,</span>
    types<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>TransactionRequest<span class="token punctuation">,</span> H160<span class="token punctuation">}</span><span class="token punctuation">,</span>
    utils<span class="token punctuation">:</span><span class="token punctuation">:</span>parse_ether<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Arc<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider<span class="token punctuation">:</span> Arc<span class="token operator">&lt;</span>Provider<span class="token operator">&lt;</span>Http<span class="token operator">>></span> <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Http<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> from_adr<span class="token punctuation">:</span> H160 <span class="token operator">=</span> <span class="token string">"0x6fC21092DA55B392b045eD78F4732bff3C580e2c"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> to_adr<span class="token punctuation">:</span> H160 <span class="token operator">=</span> <span class="token string">"0x000000000000000000000000000000000000dead"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token function">parse_ether</span><span class="token punctuation">(</span><span class="token number">1u64</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>

    <span class="token keyword">let</span> tx <span class="token operator">=</span> TransactionRequest<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>from_adr<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>to_adr<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">call_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，我们初始化一个新的 provider 并创建一个交易，将 1 ETH 从一个地址发送到另一个地址。然后我们使用 <code>provider.call_raw()</code>，它返回一个 <code>CallBuilder</code>。从这里，我们可以使用 <code>await</code> 将调用发送到节点，行为与简单使用 <code>provider.call()</code> 相同。我们还可以通过使用 <code>RawCall</code> 特性提供的方法来重写发送给节点的参数。这些方法允许我们设置调用应该在哪个区块执行，以及访问状态重写集。</p>
<p>以下是一个示例，执行相同的原始调用，但在前一个区块上执行。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>call_raw<span class="token punctuation">:</span><span class="token punctuation">:</span>RawCall<span class="token punctuation">,</span> Http<span class="token punctuation">,</span> Middleware<span class="token punctuation">,</span> Provider<span class="token punctuation">}</span><span class="token punctuation">,</span>
    types<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>BlockId<span class="token punctuation">,</span> TransactionRequest<span class="token punctuation">,</span> H160<span class="token punctuation">}</span><span class="token punctuation">,</span>
    utils<span class="token punctuation">:</span><span class="token punctuation">:</span>parse_ether<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Arc<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider<span class="token punctuation">:</span> Arc<span class="token operator">&lt;</span>Provider<span class="token operator">&lt;</span>Http<span class="token operator">>></span> <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Http<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> from_adr<span class="token punctuation">:</span> H160 <span class="token operator">=</span> <span class="token string">"0x6fC21092DA55B392b045eD78F4732bff3C580e2c"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> to_adr<span class="token punctuation">:</span> H160 <span class="token operator">=</span> <span class="token string">"0x000000000000000000000000000000000000dead"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token function">parse_ether</span><span class="token punctuation">(</span><span class="token number">1u64</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>

    <span class="token keyword">let</span> tx <span class="token operator">=</span> TransactionRequest<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>from_adr<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>to_adr<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> previous_block_number<span class="token punctuation">:</span> BlockId <span class="token operator">=</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token function">get_block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await? <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">call_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>previous_block_number<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们来看一下如何使用状态重写集。简而言之，状态重写集是一个可选的地址到状态的映射，每个条目指定在执行调用之前某些状态将被暂时重写。状态重写集允许你重写账户余额、账户的 nonce、给定地址的代码、账户存储的整个状态或账户存储中的单个槽位。请注意，状态重写集不是默认功能，并且并非每个节点都可以使用。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> ethers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    providers<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
        call_raw<span class="token punctuation">:</span><span class="token punctuation">:</span>RawCall<span class="token punctuation">,</span>
        Http<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    types<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>TransactionRequest<span class="token punctuation">,</span> H160<span class="token punctuation">,</span> U256<span class="token punctuation">,</span> U64<span class="token punctuation">}</span><span class="token punctuation">,</span>
    utils<span class="token punctuation">:</span><span class="token punctuation">:</span>parse_ether<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Arc<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
async <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> eyre<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rpc_url <span class="token operator">=</span> <span class="token string">"https://eth.llamarpc.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> provider<span class="token punctuation">:</span> Arc<span class="token operator">&lt;</span>Provider<span class="token operator">&lt;</span>Http<span class="token operator">>></span> <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Provider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Http<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">try_from</span><span class="token punctuation">(</span>rpc_url<span class="token punctuation">)</span>?<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> from_adr<span class="token punctuation">:</span> H160 <span class="token operator">=</span> <span class="token string">"0x6fC21092DA55B392b045eD78F4732bff3C580e2c"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> to_adr<span class="token punctuation">:</span> H160 <span class="token operator">=</span> <span class="token string">"0x000000000000000000000000000000000000dead"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token function">parse_ether</span><span class="token punctuation">(</span><span class="token number">1u64</span><span class="token punctuation">)</span>?<span class="token punctuation">;</span>

    <span class="token keyword">let</span> tx <span class="token operator">=</span> TransactionRequest<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>from_adr<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>to_adr<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> state <span class="token operator">=</span> spoof<span class="token punctuation">:</span><span class="token punctuation">:</span>State<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 将账户余额设置为最大 u256</span>
    state<span class="token punctuation">.</span><span class="token function">account</span><span class="token punctuation">(</span>from_adr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span>U256<span class="token punctuation">:</span><span class="token punctuation">:</span>MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 将 nonce 设置为 0</span>
    state<span class="token punctuation">.</span><span class="token function">account</span><span class="token punctuation">(</span>from_adr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nonce</span><span class="token punctuation">(</span>U64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">call_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span>await?<span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个示例中，<code>from_adr</code> 的账户余额和 nonce 被重写。状态重写集是一个非常强大的工具，可以用来模拟复杂的交易，而无需进行任何实际的状态更改。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                           
                        </div>
                    
                </div>
                <div class="post_share"
                     style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
            <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
                <div class="article-badge left-badge text-color">
                    <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
                </div>
                <div class="card">
                    <a href="/2025/03/07/ethers-rszhi-provider/">
                        <div class="card-image">
                            
                                
                                <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="ethers-rs之Provider">
                            
                            <span class="card-title">ethers-rs之Provider</span>
                        </div>
                    </a>
                    <div class="card-content article-content">
                        <div class="summary block-with-text">
                            
                                Http 提供者（Provider）Http 提供者通过 HTTP 连接到以太坊节点，允许你发送 RPC 请求以获取数据、模拟合约调用、发送交易等。

1.初始化 Http 提供者1. 使用 try_from 方法创建 Provider最简
                            
                        </div>
                        <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2025-03-07
                            </span>
                            <span class="publish-author">
                                
                                    <i class="fa fa-bookmark fa-fw icon-category"></i>
                                    
                                        <a href="/categories/WEB3/" class="post-category">
                                    WEB3
                                </a>
                                    
                                
                            </span>
                        </div>
                    </div>

                    
                </div>
            </div>
        
        
            <div class="article col s12 m6" data-aos="fade-up">
                <div class="article-badge right-badge text-color">
                    下一篇&nbsp;<i class="fa fa-chevron-right"></i>
                </div>
                <div class="card">
                    <a href="/2025/03/07/ethers-rszhi-gou-jian-yi-tai-fang-xiang-mu/">
                        <div class="card-image">
                            
                                
                                <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="ethers-rs之构建以太坊项目">
                            
                            <span class="card-title">ethers-rs之构建以太坊项目</span>
                        </div>
                    </a>
                    <div class="card-content article-content">
                        <div class="summary block-with-text">
                            
                                本节介绍如何使用 ethers-rs（一个Rust语言的以太坊库）初始化新项目、配置传输方式，并连接到以太坊节点。通过 ethers-rs，开发者可以与以太坊区块链交互，例如查询区块号、发送交易或调用智能合约。本文档将逐步讲解设置过程，并为
                            
                        </div>
                        <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2025-03-07
                            </span>
                            <span class="publish-author">
                                
                                    <i class="fa fa-bookmark fa-fw icon-category"></i>
                                    
                                        <a href="/categories/WEB3/" class="post-category">
                                    WEB3
                                </a>
                                    
                                
                            </span>
                        </div>
                    </div>
                    
                </div>
            </div>
        
    </div>
</article>
</div>




<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

    <script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

    <script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->


<!-- 代码块折行 -->

    <style type="text/css">
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }
    </style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

    <div id="floating-toc-btn" class="hide-on-med-and-down">
        <a class="btn-floating btn-large bg-color">
            <i class="fa fa-list"></i>
        </a>
    </div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换 TOC 目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2022</span>
            <a href="/about" rel="external nofollow noreferrer">xinyichen</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> 
            <br>
			 <span id="sitetime">载入运行时间...</span>
            
            
            
            
            <br>
            
			
			 
				&nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
						class="white-color">412.5k</span>&nbsp;字
             
            

                
                <script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "5";
                        var startDate = "26";
                        var startHour = "21";
                        var startMinute = "10";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                            minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                            diffMinutes * minutes) / seconds);
                        if (startYear == todayYear) {
                            document.getElementById("year").innerHTML = todayYear;
                            document.getElementById("sitetime").innerHTML = "本站已运行 " + diffDays + " 天 " + diffHours +
                                " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays +
                                " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        }
                    }

                    setInterval(siteTime, 1000);
                </script>
            

        </div>
        <!-- <div class="col s12 m4 l4 social-link ">

















</div> -->
    </div>
</footer>

<div class="progress-bar"></div>



<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<!-- 异步加载 search.js -->
<script src="/js/search.js"></script>

<!-- 延迟加载 search.xml -->
<script type="text/javascript">
    $(function () {
        // 延迟500毫秒加载搜索数据，避免阻塞页面加载
        setTimeout(function () {
            searchFunc("/search.xml", 'searchInput', 'searchResult');
        }, 500);
    });
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->


<!-- Baidu Analytics -->


<!-- Baidu Push -->


    <script src="/libs/others/clicklove.js" async="async"></script>




<script type="text/javascript">
    var OriginTitile = document.title,
        st;
    document.addEventListener("visibilitychange", function () {
        document.hidden ? (document.title = "(oﾟvﾟ)ノ Hi", clearTimeout(st)) : (document.title =
            "(*´∇｀*) 欢迎回来！", st = setTimeout(function () {
            document.title = OriginTitile
        }, 3e3))
    })
</script>

<!-- 在线聊天工具  -->



<!-- 背景 canvas-nest -->



    <script src="/libs/instantpage/instantpage.js" type="module"></script>


<script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=i;var e=n.imageLazyLoadSetting.isSPA,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight||document.documentElement.clientHeight)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},n.src=i}()}i(),n.addEventListener("scroll",function(){var t,e;t=i,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body>
</html>