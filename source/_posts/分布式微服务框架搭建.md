---
layout: posts
title: 分布式微服务框架搭建
date: 2020-08-04 15:59:00
updated: 2020-09-09 07:51:14
tags: 
categories: 
 - 总结
---
###  nacos、openFeign搭建分布式微服务

###  一、集成nacos作为注册、配置中心

####  nacos作为注册中心：

#####  1.引入nacos依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-nacos-discovery</artifactId>
    <version>2.1.0.RELEASE</version>
</dependency>
```

#####  2.启动类添加注解

```java
@EnableDiscoveryClient
@MapperScan("com.xxx.xxx.dao")
@SpringBootApplication
public class XxxApplication {
	...
}
```

#####  3.编写配置

```yml
spring:
   # 指定nacos地址 
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.58.1:8848
    # 指定服务名 必须指定！否则无法在nacos注册
  application:
    name: mall-coupon
```

#####  4.启动nacos 启动应用 查看注册信息确保服务全部注册成功

------



####  nacos作为配置中心：

#####  1.导入依赖

```xml
<!-- nacos配置中心 -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-nacos-config</artifactId>
</dependency>
```

#####  2.创建bootstrap.properties

```properties
# 当前服务名
spring.application.name=mall-coupon
# nacos地址
spring.cloud.nacos.config.server-addr=192.168.58.1:8848

# 使用微服务名创建自己的命名空间，使用配置分组完成环境隔离dev test prod
# 指定命名空间用于隔离环境
# spring.cloud.nacos.config.namespace=5fb501da-315f-415b-9601-097719546e0f
# 指定分组
# spring.cloud.nacos.config.group=1111
```

#####  3.在nacos创建配置文件 默认规则 应用名.properties

![K@J__X`1T~CAX3E_BBT~__G.png](https://i.loli.net/2020/08/04/uatNJh9qyGAf3Wk.png)

#####  4.在conctroller添加注解**@RefreshScope**并编写代码

```java
@RefreshScope //动态刷新配置
@RestController
public class CouponController {
    @Value("${user.name}")
    private String name;
    @Value("${user.age}")
    private String age;

    /**
     * <description>测试配置中心</description>
     * @return
     */
    @RequestMapping("/testNacosConfig")
    public R testNacosConfig(){
        return R.ok().put("name",name).put("age",age);
    }
}
```

#####  5.启动测试

<img src="https://i.loli.net/2020/08/04/FyIauq3KHiECJRj.png" alt="`XG_82W~X_LI@3L_FB_2EXV.png"  />

```json
{
"msg": "success",
"code": 0,
"name": "saber",
"age": "18"
}
```

#####  6.修改配置

![3GC3U_9_GC__040BUPXQF~Q.png](https://i.loli.net/2020/08/04/NEapJI1fA3c4VWu.png)

控制台提示配置已刷新

![44YDQ_RDF0__@_G`WA7BUA9.png](https://i.loli.net/2020/08/04/PXDxQgqVdTc5kUJ.png)

```json
{
"msg": "success",
"code": 0,
"name": "lancer",
"age": "20"
}
```



------



------

####  二、集成openFeign远程服务调用

#####  1.引入openfeign依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

#####  2.编写接口 添加@FeignClient注解

```java
@FeignClient("需要调用的服务名")
public interface XxxFeignService {
    /**
     *  <description>测试远程rpc调用</description>
     *  和被调用的方法保持签名一致
     * @return
     */
    @RequestMapping("方法路径")
    public R memberCoupons();
}
```

#####  3.controller层直接注入XXXFeignService

```java
@RestController
public interface XxxController {
	@Autowired
	private XxxFeignService xxxFeignService;
    /**
     *  <description>测试远程rpc调用</description>
     * @return
     */
    @RequestMapping("/test")
    public R memberCoupons(){
    	return xxxFeignService.memberCoupons();
    }
```

#####  4.启动类添加注解

```java
@EnableFeignClients(basePackages = "com.xxx.xxx.xxx") //远程调用接口包
@EnableDiscoveryClient //开启服务发现
@MapperScan("com.xxx.xxx.xxx.dao")
@SpringBootApplication
public class XxxApplication {
    public static void main(String[] args) {
        ...
    }

}
```

#####  5.启动测试

```xml
如果远程服务掉线会提示 connect time out executing ......
```



------

####  三、集成Hystrix服务熔断

![M@9N3DXA0XX1F`Y3~@ZM4_4.png](https://i.loli.net/2020/09/09/u1ctq9lkRCaJUET.png)

#####  1.导入依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
</dependency>
```

#####  2.添加配置

```xml
# 开启服务熔断
feign.hystrix.enabled=true
# 设置超时时间
hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=6000
```

#####  3.编写实体类实现远程调用接口

```java
/**
 * 远程阿里云视频操作接口
 * @author saber
 */
@FeignClient(name = "service-vod",fallback = VodFileDegradeFeignClient.class) //调用的服务名称
@Component
public interface VodClient {

    /**
     * 根据视频id删除阿里云视频
     * @PathVariable注解一定要指定参数名称，否则出错
     * @param id
     * @return
     */
    @DeleteMapping("/eduvod/video/removeAlyVideo/{id}")
    public R removeAlyVideo(@PathVariable("id") String id);

    /**
     * 定义调用删除多个视频的方法
     * @param videoIdList 参数多个视频id
     * @return
     */
    @DeleteMapping("/eduvod/video/delete-batch")
    public R deleteBatch(@RequestParam("videoIdList") List<String> videoIdList);
}

```

#####  4.feign接口添加兜底方法

```java
import com.zjm.commonutils.result.R;
import com.zjm.eduservice.client.VodClient;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * 远程服务调用失败兜底方法
 * @author saber
 */
@Component
public class VodFileDegradeFeignClient implements VodClient {
    @Override
    public R removeAlyVideo(String id) {
        return R.error().message("删除视频出错了");
    }

    @Override
    public R deleteBatch(List<String> videoIdList) {
        return R.error().message("删除多个视频出错了");
    }
}
```

