---
layout: posts
title: 阿里云文件上传
date: 2020-03-18 17:38:21
updated: 2020-03-18 17:38:21
tags: 
categories: 
 - Java
---
## 导入依赖
```xml
<!-- 阿里云OSS -->
<dependency>
   <groupId>com.aliyun.oss</groupId>
   <artifactId>aliyun-sdk-oss</artifactId>
   <version>2.5.0</version>
</dependency>
```
## 配置阿里云

```properties
aliyun.oss.endpoint=oss-cn-beijing.aliyuncs.com
aliyun.oss.accessKeyId=xxxxxxxxx
aliyun.oss.accessKeySecret=xxxxxxxxx
aliyun.oss.bucketName=xxxxxxxxx
aliyun.oss.policy.expire=300
aliyun.oss.maxSize=10
aliyun.oss.dir.prefix=gmall/images/
```
## 阿里云esc控制台开启跨域支持
## 前端点击文件上传请求后台 调用Controller

```java
//指定跨域来源 禁止非www.baidu.com来源访问
//@CrossOrigin(origins = "www.baidu.com")
@CrossOrigin
@Controller
@Api(tags = "OssController",description = "Oss管理")
@RequestMapping("/aliyun/oss")
public class OssController {
	@Autowired
	private OssCompent ossComponent;

	@ApiOperation(value = "oss上传签名生成")
	@GetMapping(value = "/policy")
	@ResponseBody
	public Object policy() {
		OssPolicyResult policy = ossComponent.policy();
		return new CommonResult().success(policy);
	}

}
```

```java

/**
 * 给前端返回一个阿里云文件上传的签证
 */
@Slf4j
@Service
public class OssCompent {

    @Value("${aliyun.oss.policy.expire}")
    private int ALIYUN_OSS_EXPIRE;
    @Value("${aliyun.oss.maxSize}")
    private int ALIYUN_OSS_MAX_SIZE;
    @Value("${aliyun.oss.bucketName}")
    private String ALIYUN_OSS_BUCKET_NAME;
    @Value("${aliyun.oss.endpoint}")
    private String ALIYUN_OSS_ENDPOINT;
    @Value("${aliyun.oss.dir.prefix}")
    private String ALIYUN_OSS_DIR_PREFIX;

    @Value("${aliyun.oss.accessKeyId}")
    private String ALIYUN_OSS_KEY;
    @Value("${aliyun.oss.accessKeySecret}")
    private String ALIYUN_OSS_SECRET_KEY;

    @Autowired
    private OSSClient ossClient;

   /**

    * 签名生成
      */
	public OssPolicyResult policy() {
        OssPolicyResult result = new OssPolicyResult();
        // 存储目录
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
        String dir = ALIYUN_OSS_DIR_PREFIX+sdf.format(new Date());
        // 签名有效期
        long expireEndTime = System.currentTimeMillis() + ALIYUN_OSS_EXPIRE * 1000;
        Date expiration = new Date(expireEndTime);
        // 文件大小
        long maxSize = ALIYUN_OSS_MAX_SIZE * 1024 * 1024;
        // 提交节点
        String action = "http://" + ALIYUN_OSS_BUCKET_NAME + "." + ALIYUN_OSS_ENDPOINT;
        try {
            PolicyConditions policyConds = new PolicyConditions();
            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, maxSize);
            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);
            String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);
            byte[] binaryData = postPolicy.getBytes("utf-8");
            String policy = BinaryUtil.toBase64String(binaryData);
            String signature = ossClient.calculatePostSignature(postPolicy);
            // 返回结果
        result.setAccessKeyId(ossClient.getCredentialsProvider().getCredentials().getAccessKeyId());
            result.setPolicy(policy);
            result.setSignature(signature);
            result.setDir(dir);
            result.setHost(action);
        } catch (Exception e) {
            log.error("签名生成失败", e);
        }
        return result;
}
    
@Bean
public OSSClient ossClient(){

	//public OSSClient(String endpoint, String accessKeyId, String secretAccessKey)
	OSSClient ossClient = new OSSClient(ALIYUN_OSS_ENDPOINT, ALIYUN_OSS_KEY, ALIYUN_OSS_SECRET_KEY);
	return ossClient;
}
```
## 前端拿到签名上传文件
## 思考：这么做好处在哪儿？
### 1.文件上传全交给前端，减少了后端并发量
### 2.生成的签证只能使用一次，提升了安全性
